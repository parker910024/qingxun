# Customise this file, documentation can be found here:
# https://github.com/fastlane/fastlane/tree/master/fastlane/docs
# All available actions: https://docs.fastlane.tools/actions
# can also be listed using the `fastlane actions` command

# Change the syntax highlighting to Ruby
# All lines starting with a # are ignored when running `fastlane`

# If you want to automatically update fastlane if a new version is available:
# update_fastlane

# This is the minimum version number required.
# Update this, if you use features of a newer version
fastlane_version "2.28.3"

default_platform :ios

#å£°æ˜

APP_NAME = "LookingLove"
WORKSPACE = "LookingLove.xcworkspace"
SCHEME = "LookingLove"
IPA_NAME = "#{APP_NAME}.ipa"
START_DATE = Time.now.strftime('%Y-%m-%d %H:%M:%S %A')
START_TIME = Time.now
DSYMFILE = "#{APP_NAME}.app.dSYM.zip" # dsymç¬¦å·è¡¨æ–‡ä»¶
ENV_APPLESTORE = ""
CONFIGURATION = "Debug"       # é»˜è®¤æ˜¯ Debug (å¯é€‰ Release)
EXPORT_METHOD = "development" # é»˜è®¤æ˜¯ development ï¼ˆå¯é€‰ ad-hocï¼Œapp-storeï¼‰
OUTPUT_DIRECTORY = "./archive/#{CONFIGURATION}" # IPA æ–‡ä»¶å¯¼å‡ºåœ°å€(ç¬¦å·è¡¨æ–‡ä»¶)

platform :ios do
  before_all do

    def colorize(text, color_code)
      "\e[#{color_code}m#{text}\e[0m"
    end

    def green(text); colorize(text, 32); end
    def magenta(text); colorize(text, 35); end
    def cyan(text); colorize(text, 36); end

    desc "project TuTu archive debug ipa to fir"
    puts "" + magenta("====== ğŸš€ğŸš€ project TuTu archive debug ipa to fir ğŸš€ğŸš€ ======") + ""
    puts "" + green("====== ğŸš€ğŸš€ æ‰“åŒ…å¼€å§‹çš„æ—¶é—´ä¸º: #{START_DATE} ==== ğŸš€ğŸš€ ======") + ""

  end

  # debug 
  desc "1. å‘å¸ƒiOS Dubug ipa åˆ° firim ç½‘ç«™"
  lane :d do

    CONFIGURATION = "Debug"
    EXPORT_METHOD = "development"
    archiveAction
    # a(configuration: 'Debug', 
    #   export_method: 'development',
    #   app_id: "f80a6c7ccc",
    #   app_key: "b3549e1a-11ae-40ed-8568-29b5b72c61a2",
    #   channel: "Debug")
  end

  # release
  desc "2. å‘å¸ƒiOS Release ipa åˆ° firim ç½‘ç«™"
  lane :r do
    CONFIGURATION = "Release"
    archiveAction
    # a(configuration: 'Release', 
    #   export_method: 'ad-hoc',
    #   app_id: "f80a6c7ccc",
    #   app_key: "b3549e1a-11ae-40ed-8568-29b5b72c61a2",
    #   channel: "Release")
  end

  # appstore
  desc "3. å‘å¸ƒiOS Release ipa åˆ° è‹¹æœå•†åº—"
  lane :store do

    ENV_APPLESTORE = "Apple Store"
    CONFIGURATION = "Release"
    EXPORT_METHOD = "app-store" # é»˜è®¤æ˜¯ development ï¼ˆå¯é€‰ ad-hocï¼Œapp-storeï¼‰

    archiveAction
    # a(configuration: 'Release', 
    #   export_method: 'app-store', 
    #   app_id: "bf08dfb921",
    #   app_key: "e80e6e30-e975-40e3-868e-8ffbe4dd0d5a", 
    #   channel: "Release")

  end

  # archive
  desc "4. æ‰“åŒ…æ“ä½œ"
  lane :archiveAction do

  	#1. å¼€å§‹å‰çš„ä¸€äº›æ“ä½œï¼Œå¦‚ä»£ç æ›´æ–°(git_pull)

    #git_pull # æ‹‰å–æ–°ä»£ç 
    # cocoapods(repo_update:true)
    #sh "pod update"

    #è‡ªåŠ¨å¢åŠ build
    updateProjectBuildNumber

    # å¼€å§‹æ—¶é—´
    startDate = Time.now.strftime('%Y-%m-%d %H:%M:%S %A')
    startTime = Time.now
    puts "" + magenta("====== ğŸš€ğŸš€ æ‰“åŒ…å¼€å§‹çš„æ—¶é—´ä¸º: #{startDate} ==== ğŸš€ğŸš€ ======") + ""
 
    #gymé…ç½®,æ‰“åŒ…è¾“å‡ºã€‚

    #fastlane gym --export_method ad-hoc
    #fastlane gym --export_method enterprise
    #fastlane gym --export_method app-store
    #æ¸…é™¤ä¸Šä¸€æ¬¡çš„ipaæ–‡ä»¶
    #clean_ipafile
    #å¯¼å‡ºè·¯å¾„ 
    # output_directory = "./archive/#{configuration}"
    # å¼€å§‹æ‰“åŒ…
    gym(
      # æŒ‡å®šæ‰“åŒ…æ‰€ä½¿ç”¨çš„è¾“å‡ºæ–¹å¼ï¼Œç›®å‰æ”¯æŒapp-store, package, ad-hoc, enterprise, development
      export_method: EXPORT_METHOD,     
      export_xcargs: "-allowProvisioningUpdates",
      workspace: WORKSPACE,
      # æŒ‡å®šæ‰“åŒ…æ–¹å¼ï¼ŒRelease æˆ–è€… Debug
      configuration: CONFIGURATION,
      # æŒ‡å®šschemeçš„åå­—
      scheme: SCHEME,
      # æ˜¯å¦æ¸…ç©ºä»¥å‰çš„ç¼–è¯‘ä¿¡æ¯ trueï¼šæ˜¯
      clean:true,
      # æŒ‡å®šè¾“å‡ºæ–‡ä»¶å¤¹ï¼Œè¿™é‡Œä¼šä¿å­˜æˆ‘ä»¬æœ€åç”Ÿæˆçš„ipaæ–‡ä»¶
      output_directory: OUTPUT_DIRECTORY,
      # è¾“å‡ºçš„ipaåç§°
      output_name: IPA_NAME
     )

    if ENV_APPLESTORE == "Apple Store"
      #do Something
      uploadAppleStore
    else 
      #do Otherthing
      uploadToFirim
    end

    # ä¸Šä¼ ç¬¦å·è¡¨
    upload_dSYM

    # ç»Ÿè®¡ç»“æŸæ—¶é—´
    endDate = Time.now.strftime('%Y-%m-%d %H:%M:%S %A')
    endTime = Time.now

    # è¾“å‡ºæ‰“åŒ…å¼€å§‹æ—¶é—´ å’Œ ç»“æŸæ—¶é—´
    puts "" + magenta("====== ğŸš€ğŸš€ æ‰“åŒ…æ‰§è¡Œå¼€å§‹çš„æ—¶é—´ä¸º: #{START_DATE} ==== ğŸš€ğŸš€ ======") + ""
    puts "" + magenta("====== ğŸš€ğŸš€ æ‰“åŒ…æ‰§è¡Œç»“æŸçš„æ—¶é—´ä¸º: #{endDate} ==== ğŸš€ğŸš€ ======") + ""

    # è¾“å‡ºæ€»ç”¨æ—¶
    SECONDS = endTime - START_TIME
    UI.message("æ‰§è¡Œå®Œæ¯•ï¼Œç”¨æ—¶" + cyan("#{SECONDS}") + "ç§’")
    
  end

  # ä¸Šä¼ åˆ° firim 
  desc "5. æ‰§è¡Œä¸Šä¼ æ“ä½œ"
  lane :uploadToFirim do
    puts "" + magenta("====== ğŸš€ğŸš€ ==== æ‰§è¡Œä¸Šä¼ åˆ° fir çš„å‘½ä»¤ ==== ğŸš€ğŸš€ ======") + ""
    
    # æ‰“åŒ…å†…å®¹ï¼ˆchange logï¼‰çš„æå–å’Œç”Ÿæˆ
    changelog_from_git_commits(
      # commit message èŒƒå›´ï¼šè‡ªä¸Šæ¬¡æˆåŠŸæäº¤è‡³å½“å‰æœ€æ–°æäº¤
      # between: [ENV['GIT_PREVIOUS_SUCCESSFUL_COMMIT'] || "HEAD^", "HEAD"],
      commits_count: 5,
      # æ ¼å¼åŒ–ï¼Œ%s ä»£è¡¨ commit messageï¼Œ%an ä»£è¡¨æäº¤äººå
      pretty: "\n - %s (%an)",
      # å¿½ç•¥ Merge ä¿¡æ¯
      merge_commit_filtering: 'exclude_merges',
    )

    # fir çš„é…ç½®ä¿¡æ¯

    ipaDownloadPwd = "1230" # ä¸‹è½½å¯†ç 
    appUpdateLog = "è½»å¯»App #{CONFIGURATION} ç‰ˆæœ¬æ›´æ–°äº†. \n è¿‘æœŸæ›´æ–°ï¼š#{lane_context[SharedValues::FL_CHANGELOG]}"

    # firim(firim_api_token: "f3702bf3ca940b78fd758efeb4e6cb09", 
    #     app_changelog: "#{appUpdateLog}", 
    #     firim_api_url: "http://api.jappstore.com/", 
    #           ipa:"#{OUTPUT_DIRECTORY}/#{IPA_NAME}",
    #        app_passwd: "#{ipaDownloadPwd}") # è¿™é‡Œæ¢æˆè‡ªå·±firä¸­çš„tokenå³å¯


    pgyer(update_description: "#{appUpdateLog}",
             api_key: "58696d2dee66113ed3677eb62bfb4337",
            user_key: "0bbbecf67c61a1c28561af835c92ae76", 
                 ipa: "#{OUTPUT_DIRECTORY}/#{IPA_NAME}",
          install_type: "2", #set install type for app (1=public, 2=password, 3=invite).
            password: "#{ipaDownloadPwd}")

    puts "" + magenta("====== ğŸš€ğŸš€ ------ ä¸Šä¼ åˆ° fir æˆåŠŸï¼Œ è¯·æŸ¥çœ‹ ------- ğŸš€ğŸš€ ======") + ""

  end

  # 
  desc "6. å‘å¸ƒåˆ° Apple Store"
  lane :uploadAppleStore do

  deliver(force: false, skip_screenshots: true, skip_metadata: true)
  puts "" + magenta("====== ğŸš€ğŸš€ ------ ä¸Šä¼ åˆ° Apple Store æˆåŠŸï¼Œ è¯·æŸ¥çœ‹ ------- ğŸš€ğŸš€ ======") + ""

  end

  # ç”¨äºæ›´æ–° App çš„ build Num çš„æ–¹æ³•
  desc "7. ç”¨äºæ›´æ–° App çš„ build Num çš„æ–¹æ³•"
  lane :updateProjectBuildNumber do

    # è·å–å½“å‰æ—¶é—´
    currentTime = Time.new.strftime("%Y%m%d")
    # è·å–å½“æœŸç‰ˆæœ¬å·
    build = get_build_number()

    if build.include?"#{currentTime}"
    # => ä¸ºå½“å¤©ç‰ˆæœ¬ è®¡ç®—è¿­ä»£ç‰ˆæœ¬å·
    lastStr = build[build.length-2..build.length-1]
    lastNum = lastStr.to_i
    lastNum = lastNum + 1
    lastStr = lastNum.to_s

    if lastNum < 10
    lastStr = lastStr.insert(0,"0")
    end
    # å¦‚æœæ˜¯å½“å¤©çš„ç‰ˆæœ¬ æ ¼å¼ä¸ºï¼š2019122703 å½“å¤©çš„å¹´æœˆæ—¥åŠ ä¸Šæ„å»ºçš„æ¬¡æ•° æ—¥æœŸ+build 
    build = "#{currentTime}#{lastStr}"
    else
    # => éå½“å¤©ç‰ˆæœ¬ build å·é‡ç½®
    build = "#{currentTime}01"
    end
    UI.message("*************| " + magenta("æ›´æ–° Build #{build}") + " |*************")
    # => æ›´æ”¹é¡¹ç›® build å·
    increment_build_number(
    build_number: "#{build}"
    )

  end

  desc "8. ä¸Šä¼ ç¬¦å·è¡¨æ“ä½œ"
  lane :upload_dSYM do
    #ä¸Šä¼ ç¬¦å·è¡¨åˆ° bugly
  
  bugly(app_id: "bf08dfb921", 
        app_key: "e80e6e30-e975-40e3-868e-8ffbe4dd0d5a",
        symbol_type: 2,
        bundle_id: "com.wudoo.qingxun",
        product_version: "1.3.2",
        channel: CONFIGURATION,
		dsym: "#{OUTPUT_DIRECTORY}/#{DSYMFILE}"
        )

  end

  lane :resigh do

    resign(
      ipa: "#{OUTPUT_DIRECTORY}/#{IPA_NAME}", # can omit if using the `ipa` action
      signing_identity: "Apple Distribution: fulong li (A5S48JU63A)",
      provisioning_profile: "#{OUTPUT_DIRECTORY}/adhoc_qingxun.mobileprovision", # can omit if using the _sigh_ action
      )
  end


  # You can define as many lanes as you want

  after_all do |lane|
    # This block is called, only if the executed lane was successful

    slack(
      slack_url: "https://hooks.slack.com/services/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",
      message: "Successfully deployed new App Update.",
      payload: {"text": "{A very important thing has occurred! <https://fir.im/g9mv|Download> for details!"}
      )
  end

  error do |lane, exception|
    slack(
      slack_url: "https://hooks.slack.com/services/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",
      message: "æ‰“åŒ…å¤±è´¥äº†, è¯·æŸ¥çœ‹åŸå› ",
      success: false
    )
  end
end


# More information about multiple platforms in fastlane: https://github.com/fastlane/fastlane/blob/master/fastlane/docs/Platforms.md
# All available actions: https://docs.fastlane.tools/actions

# fastlane reports which actions are used
# No personal data is recorded. Learn more at https://github.com/fastlane/enhancer
